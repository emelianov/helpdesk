<?php
//request.php	v5.0.7/MySQL

include_once(OLIB_PATH.'/class.mysql.php');

define('OREQ_RESERVED',	0);
define('OREQ_WAIT',	1);
define('OREQ_PROCESS',	2);
define('OREQ_DELAY',	3);
define('OREQ_TIMEOUT',	4);
define('OREQ_DONE',	5);
define('OREQ_COMMENT',	6);
define('OREQ_RESERVE2',	7);
define('OREQ_ANALIZE',	8);
if (!defined('OREQ_TABLE')) {
 define('OREQ_TABLE',	'requests');
}
if (!defined('OREQ_CLASSES')) {
 define('OREQ_CLASSES',	'request_class');
}

class Request extends _ObjMySql {
 function __construct($rid=false) {
  $fields	= array(	'rid',		//Uniqueue request ID
				'time', 	//Create time
				'username', 	//Creator name
				'pcname', 
				'targetname', 
				'action', 	//Action code
				'text', 	//Action text
				'file', 	//Attached file
				'pid',		//Parent request ID
				'done',		//Finish time
				'result',	//Result code
				'time2',	//Processing start time
				'saprname',	//Processor
				'username2',	//Finalizer name
				'cid',		//Request class id
				'curator',	//Curator name
				'comment'	//User request comment
			);
  parent::__construct();
  $this->_db	= OREQ_TABLE;
  $this->_addField($fields, $this->_from());
  if ($rid) {
   $this->where("rid=$rid");
   $this->_execute();
  }
 }
 function _resultToString($a) {
  return $this->_actionToString($a);
 }
 function _actionToString($a) {
  switch ($a) {
  case OREQ_RESERVED:
  case OREQ_RESERVE2:
   $r	= 'гюпегепбхпнбюмн';
   break;
  case OREQ_DELAY:
   $r	= 'нркнфемю';
   break;
  case OREQ_ANALIZE:
   $r	= 'юмюкхг';
   break;
  case OREQ_PROCESS:
   $r	= 'б пюанре';
   break;
  case OREQ_TIMEOUT:
   $r	= 'нрйкнмем';
   break;
  case OREQ_DONE:
   $r	= 'цнрнб';
   break;    
  case OREQ_WAIT:
   $r	= 'нфхдюмхе';
   break;
  case OREQ_COMMENT:
   $r	= 'йнллемрюпхи';
   break;
  default:
   $r	= "мЕХГБЕЯРМН($a)";
  }
  return $r;
 }
 function _timeConvert($time) {        
  return $this->toUnixTimestamp($time);
 }                                     
 function _timeToString($time) {
  return $time?date('d-m-y H:i', $time):'';     
 }                                     
 function _timeNative($t) {
  $d	= "'".$this->toTimestamp($t)."'";
  return $d;
 }
 function _time2Convert($time) {        
  return $this->toUnixTimestamp($time);
 }                                     
 function _time2ToString($time) {       
  return $time?date('d-m-y H:i', $time):'';     
 }                                     
 function _time2Native($t) {
  $d	= "'".$this->toTimestamp($t)."'";
  return $d;
 }
 function _doneConvert($time) {        
  return $this->toUnixTimestamp($time);
 }                                     
 function _doneToString($time) {       
  return $time?date('d-m-y H:i', $time):'';     
 }                                     
 function _doneNative($t) {
  $d	= "'".$this->toTimestamp($t)."'";
  return $d;
 }
 function range($date, $interval) {             
  parent::timeRange($date, $interval, 'time');
 }
 function retrive($rid=false) {
//  $this->orderBy('time', false);
  if ($rid !== false) {
   $this->findBy("(rid=$rid OR pid=$rid)");
   $this->groupBy('rid');
  } else {
//   $this->findBy("action=1");
//   $this->findBy("(pid IS NULL OR pid = 0)");
   $this->findBy("(pid = 0)");
  }
  return $this->_execute();
 }
 function update() {
  parent::update('rid');
 }
 function contains($txt) {			//5.0.6
  $DB2		= "(SELECT IF(pid = 0,rid,pid) AS ftsid FROM requests WHERE MATCH (text) AGAINST ('$txt' IN BOOLEAN MODE)) AS fts";
  $this->_from($DB2);
  $this->where('requests.rid = fts.ftsid');
 }
}

class RequestClass extends _ObjMySql {
 function __construct($id=false) {
  parent::__construct(array(	'id',		//Uniqueue ID
				'name', 	//Class name
				'text', 	//Class text
				'file',		//Attach name
				'pid'		//Parent ID
			));
  $this->_db	= OREQ_CLASSES;
  if ($id) {
   $this->where("id='$id'");
   $this->_execute();
  } else {
   $this->orderBy('');
  }
 }
}
?>